https://www.nowcoder.com/discuss/939267
https://www.nowcoder.com/discuss/945403
https://zhuanlan.zhihu.com/p/368154495
https://blog.csdn.net/weixin_44484715/article/details/120825122
https://blog.csdn.net/daaikuaichuan/article/details/100514401

#### 线程的数目如何设置

· 对于 CPU 密集型，线程数是 CPU 数目 + 1
· 对于 I/O 密集型，线程数可以大一点 = CPU 数目 + CPU*（线程等待时间/线程CPU时间）

#### 多进程模型与多线程模型

##### 多进程模型

为每个客户端分配一个进程来处理请求。可能出现的问题：当子进程退出时，实际上内核里会保留进程的一些信息，也会占用内存，因此需要父进程去回收子进程的一些资源，否则会沦为僵尸进程，耗尽系统资源。（SIGKILL 信号捕捉函数）

##### 多线程模型

使用多线程模型的好处是线程切换开销小，但为了多线程竞争，线程在操作任务队列时需要加锁。

#### 大端序小端序

网络序是大端字节序

### Nginx

#### Nginx 如何实现异步非阻塞

Nginx 采用的是 ET 模式的 epoll。Epoll 是同步的，那 Nginx 如何实现异步呢？
正常情况下，我们调用 read() 如果数据未到达，主线程会一直占用 CPU 询问，数据是否到达，而不陷入阻塞态，直到有数据到达，主线程才读取数据，这是同步。对于 Nginx 而言，它是若调用 read() 无数据到达，会注册一个事件，然后接着处理其他事情，等到数据到达后，事件触发，主线程才读取这个数据，这是异步。

#### Nginx 反向代理

Nginx 作为 Web 服务器的 3 个功能：反向代理、静态 web 服务器、负载均衡

##### 反向代理【转发请求】

接受客户端请求，若请求是访问静态文件，则 Nginx 作为 web 服务器直接返回请求内容；若请求访问后台服务逻辑，则 Nginx 将请求转发给内部服务器处理。

反向代理的作用：
1）配合 upstream 实现负载均衡；
2）提高安全性，增加中间屏障，客户端不能直接访问后端服务；
3）提升性能，通过异步非阻塞的方式把请求传给后端，提升了并发处理能力；
4）利用缓存，提高响应速度

##### 负载均衡

> https://blog.csdn.net/zhangzeyuaaa/article/details/120810743

当有多个服务器时，根据规则随机的将请求分发到指定的服务器上处理。负载均衡配置一般都需要同时配置反向代理，通过反向代理跳转到负载均衡。
负载均衡方案主要有 3 种：1）基于 DNS 负载均衡；2）基于硬件负载均衡；3）基于软件负载均衡。DNS 负载均衡可以实现在地域上的流量均衡，硬件负载均衡主要用于大型服务器集群；软件负载均衡是基于机器层面的流量均衡。Nginx 负载均衡属于在应用层流量分发任务。

常见负载均衡策略：

> http://www.wjhsh.net/daozhangblog-p-12446424.html

1）轮询：平均分配
2）加权轮询：在轮询的基础上，增加一个权重的概念。
3）哈希法：
4）最少连接数：动态负载均衡的策略。维护活动中的连接数量，然后取最小的返回。
5）最快响应：动态负载均衡的策略。若根据每个节点过去一段时间的响应情况来分配，响应越快，分配越多。

#### HTTP 有哪些优化方案：

1）内容缓存
2）数据压缩：采用某种编码方式
3）SSL 加密：从安全性优化
4）TCP 复用：基于流 ID

#### 压力测试服务器

压测工具：WebBench 性能压力测试工具，它展示服务器的两项内容——每秒钟响应请求数、每秒种传输数据量

压测基本原理
Webbench 首先 fork 出多个子进程，每个子进程循环做 web 访问测试。子进程把访问的结果通过管道告诉父进程，父进程做统计。
由于我们在虚拟机跑，所以并发量差不多最大 7000 多，不到 1w，QPS 才 1w出头。【无法达到百万 QPS】

#### 常见多线程多进程服务器

1）Apache；2）Nginx；3）Tomcat

#### 可以多个线程/进程监听同一个端口吗？

1）5 元组（源IP，源端口，协议，目的IP，目的端口）唯一确认一个连接。对于一个端口，可以被 TCP 也可以被 UDP 监听；
2）使用端口复用，一个端口可以被多个 TCP、多个UDP 监听。【所以会出现惊群现象:accept 的时候】

### 主机上最多能保持多少个连接

> https://www.zhihu.com/question/361111920
> https://www.nowcoder.com/discuss/945403

连接通过 5 元组唯一识别（源IP，源端口，协议，目的IP，目的端口），协议包括 TCP、UDP。主要 5 元组不同，就是不同的 socket 连接。申请连接后，返回文件描述符用于通信。

#### 瓶颈1：端口号限制 —— 通过如下指令修改端口号限制，假设为 60000

`cat /proc/sys/net/ipv4/ip_local_port_range`
理论端口号是 16 位，范围是 1~65535，但实际并不是所有端口号都可以用，首先普通用户无法访问 1024 以下的端口。如果始终向同一目标 IP 和同一目标端口发出连接请求，首先会遇到端口号限制。
此时如果不断更换目标 IP 和目标端口号，可以继续发出连接请求。

#### 瓶颈2：文件描述符限制

Linux 对文件描述符的限制有 3 个级别：
1）系统级：当前系统可打开的最大数量；`通过 cat /proc/sys/fs/file-max 查看`
2）用户级：指定用户可打开的最大数量；`通过 cat /etc/security/limits.conf 查看`
3）进程级：单个进程可打开的最大数量；`通过 cat /proc/sys/fs/nr_open 查看`

#### 瓶颈3：内存限制

每个文件描述符都有一个缓冲区，若文件描述符过多，会导致内存溢出

#### 瓶颈4：CPU 限制

看 CPU 占用率多高

> 写在最后：最大TCP连接数实验https://mp.weixin.qq.com/s/f_CMt2ni0vegB3-pf2BTTg

#### 谈谈跨域问题

跨域，就是浏览器不能执行其他网站的脚本，或者说阻止接口请求，它是由浏览器的同源策略造成，是浏览器施加的安全限制。所谓同源是指：域名、协议、端口均相同。只要有个不同，就是跨域。
解决办法：后端设置解决、前端设置解决